name: ci
on: [push, pull_request]
jobs:
  lint:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install PSScriptAnalyzer
        run: Install-Module PSScriptAnalyzer -Scope CurrentUser -Force
        shell: pwsh
      - name: Lint PowerShell & export SARIF
        run: |
          # Get all PowerShell files excluding samples with intentional violations
          $files = Get-ChildItem -Path . -Include *.ps1,*.psm1,*.psd1 -Recurse | 
            Where-Object { $_.FullName -notmatch 'samples[\\/]before-' -and $_.FullName -notmatch '[\\/]\.psqa-backup[\\/]' }
          
          if ($files) {
            Invoke-ScriptAnalyzer `
              -Path $files `
              -ReportSummary `
              -Severity Error,Warning `
              -Settings ./config/PSScriptAnalyzerSettings.psd1 `
              -SaveDenyList $null `
              -OutFile PSSA.sarif `
              -Format Sarif
          }
        shell: pwsh
        continue-on-error: true
      - name: Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: PSSA.sarif

  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Pester
        run: Install-Module Pester -Scope CurrentUser -Force
        shell: pwsh
      - name: Run Pester
        run: Invoke-Pester -CI -Output Detailed
        shell: pwsh

  package:
    needs: [lint, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Zip tools
        run: |
          zip -r poshguard-${{ github.sha }}.zip \
            tools/ \
            PoshGuard/ \
            README.md \
            LICENSE \
            docs/CHANGELOG.md \
            docs/SECURITY.md \
            docs/CONTRIBUTING.md
      - uses: actions/upload-artifact@v4
        with:
          name: poshguard
          path: poshguard-${{ github.sha }}.zip
